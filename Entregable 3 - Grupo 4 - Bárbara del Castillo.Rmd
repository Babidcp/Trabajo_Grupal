---
title: "Entregable 3 (20173266)"
author: "Bárbara del Castillo Prieto (20173266)"
date: '2022-06-17'
output: html_document
---

```{r}
library(rio)
library(DescTools)
library(ggplot2)
library(moments)
library(Rmisc)
library(e1071)
library(psych)
library(dplyr)
library(gplots)
library(vcd)
library(PMCMRplus)
library(nortest)
library(car)
library(stargazer)
library(lm.beta)
library(gtools)
library(jtools)
library(ggstance)
library(broom.mixed)
library(fastDummies)
library(writexl)
library(lmtest)
library(polycor)
library(ggcorrplot)
library(matrixcalc)
library(GPArotation)
library(lavaan)
library(BBmisc)
```

```{r}
vdem = import("V-Dem-CY-Core-v12.rds")
View(vdem)
```

#1. Variable dependiente - Índice de Democracia Liberal (v2x_libdem)
```{r}
summary(vdem$v2x_libdem)
```

```{r}
str(vdem$v2x_libdem)
```

#2. Variables independientes - Bárbara del Castillo
#2.1. Organizaciones de Sociedad civil
#2.1.1. Represión gubernamental de Organizaciones de Sociedad Civil (v2csreprss_ord)
```{r}
str(vdem$v2csreprss_ord)
summary(vdem$v2csreprss_ord)
```

#2.1.2. Control gubernamental sobre Organizaciones de Sociedad Civil (v2cseeorgs_ord)
```{r}
str(vdem$v2cseeorgs_ord)
summary(vdem$v2cseeorgs_ord)
```

#2.1.3. Consulta gubernamental hacia Organizaciones de Sociedad Civil (v2cscnsult_ord)
```{r}
str(vdem$v2cscnsult_ord)
summary(vdem$v2cscnsult_ord)
```

#2. Variables independientes - Frank Pinares
#2.1. Libertad de Expresión
#2.1.1. Libertad de Discusión para Hombres (v2cldiscm_ord)
```{r}
str(vdem$v2cldiscm_ord)
summary(vdem$v2cldiscm_ord)
```

#2.1.2. Libertad de Discusión para Mujeres (v2cldiscw_ord)
```{r}
str(vdem$v2cldiscw_ord)
summary(vdem$v2cldiscw_ord)
```

#2.1.3. Libertad de Expresión Académica y Cultural (v2clacfree_ord)
```{r}
str(vdem$v2clacfree_ord)
summary(vdem$v2clacfree_ord)
```

#4. Armar la base de apoyo
```{r}
factor_barbara = subset(vdem, select = c(country_name, year, v2x_libdem, v2csreprss_ord, v2cseeorgs_ord, v2cscnsult_ord, v2cldiscm_ord, v2cldiscw_ord, v2clacfree_ord))
```

```{r}
factor_barbara = factor_barbara[factor_barbara$year==2021,]
```

```{r}
factor_barbara$country_name = NULL
factor_barbara$year = NULL
factor_barbara$v2x_libdem = NULL
```

#I. Análisis Factorial Exploratorio
#5. Explorar las correlaciones entre las variables
```{r}
corMatrix_b = polycor::hetcor(factor_barbara)$correlations
corMatrix_b
```

#6. Graficar la matriz de correlaciones
```{r}
ggcorrplot(corMatrix_b)
```

#7. Verificar validez del análisis factorial
#7.1. Verificar si variables se pueden factorizar 
Overall MSA es mayor a 0.6, por lo que el análisis factorial es factible.
```{r}
psych::KMO(corMatrix_b)
```

#7.2. Descartar una posible matriz de identidad
Sale FALSE (p-value NO es mayor a 0.05), por lo que el análisis factorial es factible.
```{r}
cortest.bartlett(corMatrix_b, n = nrow(factor_barbara))$p.value>0.05
```

#7.3. Descartar una posible matriz singular
Sale FALSE, por lo que el análisis factorial es factible.
```{r}
is.singular.matrix(corMatrix_b)
```

#8. Determinar en cuántos factores se pueden agrupar las variables
```{r}
fa.parallel(factor_barbara, fm = "ML", fa = "fa")
```

#9. Observar las cargas factoriales y ver en qué factores se ubicaría cada variable
```{r}
resfa_b <- fa(factor_barbara, nfactors = 1, cor = "mixed", rotate = "varimax", fm = "minres")
print(resfa_b$loadings, cutoff = 0.5)
```

#10. Graficar cómo se agrupan las variables
```{r}
fa.diagram(resfa_b)
```

#11. Evaluar los resultados obtenidos
#11.1. ¿Qué variables aportaron más a los factores?
```{r}
sort(resfa_b$communality)
```

#12. Observar los posibles valores proyectados
#12.1. Para grabar en la base los puntajes de los factores
```{r}
factor_barbara$puntaje = resfa_b$scores
```

#II. Análisis Factorial Confirmatorio
#13. Construir un modelo lineal 
```{r}
modelob <- "factorb =~ v2csreprss_ord + v2cseeorgs_ord + v2cscnsult_ord + v2cldiscm_ord + v2cldiscw_ord + v2clacfree_ord"
```

#14. Crear un objeto para hacer las validaciones
```{r}
cfa_fit <- cfa(modelob, data = factor_barbara, std.lv = TRUE, missing = "fiml")
```

#15. Preparar los tests para las validaciones
```{r}
allParamCFA = parameterEstimates(cfa_fit, standardized = T)
allFitCFA = as.list(fitMeasures(cfa_fit))
```

#16. Ver si cada variable tiene una buena relación con su factor (p-value < 0.05 indica que la variable observable tiene buena relación con su latente)
```{r}
allParamCFA[allParamCFA$op=="=~",]
```

#17. Ver si la asignación de variables ha sido relativamente buena (p-value > 0.05 para validar el modelo)
```{r}
allFitCFA[c("chisq", "df", "pvalue")]
```

#18. Otra prueba para ver si el análisis factorial es relativamente bueno (índice Tucker-Lewi debe ser mayor a 0.9)
```{r}
allFitCFA$tli
```

#19. Ver si la raíz del error cuadrático medio de aproximación es menor a 0.05 (ver rmsea)
```{r}
allFitCFA[c("rmsea.ci.lower", "rmsea", "rmsea.ci.upper")]
```

#20. Hacer predicciones (scores) de las variables latentes
```{r}
scorescfa = normalize(lavPredict(cfa_fit), method = "range", margin = 2, range = c(0, 10))
```

```{r}
factor_barbara$prediccion = scorescfa
```
